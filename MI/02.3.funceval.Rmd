---
title: "Functional Enrichment"
author: "Ricardo Ramirez"
date: "11/2/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Functional characterization of gene loadings

```{r setup, include=FALSE}
library(tidyverse)
```

```{r}
loadings <- read_csv("./results/MI/MOFA_mcell/factor_desc/Factor1_char/loadings.csv") %>%
  dplyr::select(-value) %>%
  dplyr::group_by(celltype) %>%
  nest() %>%
  dplyr::mutate(data = map(data, ~.x[[1]])) %>%
  deframe()
```

```{r}
gsets <- readRDS("./aux_data/Genesets_Dec19.rds")
```

## Hypergeometric test for functional enrichment

```{r}

GSE_analysis <- function(geneList,Annotation_DB){
  
  geneList = geneList[geneList %in% unique(unlist(Annotation_DB))]
  
  ResultsDF = matrix(0,nrow = length(Annotation_DB),ncol = 5)
  rownames(ResultsDF) = names(Annotation_DB)
  colnames(ResultsDF) = c("GenesInPathway","GenesInList","GeneNames","p_value","corr_p_value")
  
  DB_genecontent = length(unique(unlist(Annotation_DB)))
  GenesDB = DB_genecontent 
  SelectedGenes = length(geneList)
  
  for(gset in rownames(ResultsDF)){
    GP = length(Annotation_DB[[gset]])
    GL = length(intersect(Annotation_DB[[gset]],geneList))
    
    ResultsDF[gset,"GenesInList"] = GL
    ResultsDF[gset,"GenesInPathway"] = GP
    ResultsDF[gset,"GeneNames"] = paste(intersect(Annotation_DB[[gset]],geneList),collapse = ",")
    ResultsDF[gset,"p_value"] = phyper(q=GL - 1, m=GP, n=GenesDB-GP, k=SelectedGenes, lower.tail = FALSE, log.p = FALSE)
  }
  
  ResultsDF[,"corr_p_value"] = p.adjust(ResultsDF[,"p_value"],method = "BH")
  ResultsDF = data.frame(ResultsDF,stringsAsFactors = F)
  ResultsDF = ResultsDF[order(ResultsDF[,"p_value"]),]
  
  ResultsDF = ResultsDF %>% 
    rownames_to_column("gset") %>% 
    mutate_at(c("GenesInPathway","GenesInList",
                "p_value","corr_p_value"), 
              as.numeric) %>% 
    dplyr::arrange(corr_p_value,GenesInList)
  
  return(ResultsDF)
}
```

# Main

```{r}
cts_enrichment <- map(loadings, GSE_analysis, Annotation_DB = gsets$MSIGDB_GO_BIOLPROC)
```


```{r}
col_fun_fact <- circlize::colorRamp2(seq(0, 5, length = 50), hcl.colors(50, "Blues",rev = T))

neg_sets <- cts_enrichment %>% 
  enframe() %>%
  unnest() %>%
  dplyr::filter(corr_p_value < 0.25,
                grepl("neg",name)) %>%
  dplyr::group_by(name) %>%
  slice(1:7) %>%
  pull(gset)
  
neg_enrichment <- cts_enrichment %>% 
  enframe() %>%
  unnest() %>%
  dplyr::filter(gset %in% neg_sets,
                grepl("neg",name)) %>%
  dplyr::mutate(corr_p_value = -log10(corr_p_value)) %>%
  dplyr::mutate(corr_p_value = ifelse(corr_p_value > 5, 5, corr_p_value)) %>%
  dplyr::mutate(gset = gsub("GO_", "", gset) %>% strtrim(width = 35),
                name = gsub("_neg", "", name))
                
pdf("./results/MI/MOFA_mcell/factor_desc/Factor1_char/functional_healthy.pdf", height = 3.4, width = 3.8)

neg_enrichment %>%
  dplyr::select(name, gset, corr_p_value) %>%
  pivot_wider(names_from = name, values_from = corr_p_value) %>%
  column_to_rownames("gset") %>%
  ComplexHeatmap::Heatmap(., name = "-log10(p)",
                          show_row_dend = F, 
                          show_column_dend = F, 
                          row_names_gp = grid::gpar(fontsize = 6),
                          column_names_gp = grid::gpar(fontsize = 10),
                          col = col_fun_fact)

dev.off()

```

```{r}
col_fun_fact <- circlize::colorRamp2(seq(0, 5, length = 50), hcl.colors(50,"Reds",rev = T))

pos_sets <- cts_enrichment %>% 
  enframe() %>%
  unnest() %>%
  dplyr::filter(corr_p_value < 0.25,
                grepl("pos",name)) %>%
  dplyr::group_by(name) %>%
  slice(1:5) %>%
  pull(gset)
  
pos_enrichment <- cts_enrichment %>% 
  enframe() %>%
  unnest() %>%
  dplyr::filter(gset %in% pos_sets,
                grepl("pos",name)) %>%
  dplyr::mutate(corr_p_value = -log10(corr_p_value)) %>%
  dplyr::mutate(corr_p_value = ifelse(corr_p_value > 5, 5, corr_p_value)) %>%
  dplyr::mutate(gset = gsub("GO_", "", gset) %>% strtrim(width = 30),
                name = gsub("_pos", "", name))

pdf("./results/MI/MOFA_mcell/factor_desc/Factor1_char/functional_dis.pdf", height = 3, width = 3.8)

pos_enrichment %>%
  dplyr::select(name, gset, corr_p_value) %>%
  pivot_wider(names_from = name, values_from = corr_p_value) %>%
  column_to_rownames("gset") %>%
  ComplexHeatmap::Heatmap(., name = "-log10(p)",
                          show_row_dend = F, 
                          show_column_dend = F, 
                          row_names_gp = grid::gpar(fontsize = 7),
                          column_names_gp = grid::gpar(fontsize = 10),
                          col = col_fun_fact)

dev.off()
```






